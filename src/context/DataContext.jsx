import React, { createContext, useEffect, useState } from 'react';
import PropTypes from 'prop-types';

import { evaluateData } from '../helpers';

export const DataContext = createContext();

const defaults = {
  name: '123 Main St. (Edit me)',
  homeValue: '115000.00',
  purchasePrice: '115000.00',
  downPayment: '0.2,30000.00,P',
  closingCosts: '0.03,2000.00,P',
  additionalCosts: '0',
  rent: '1100.00',
  propertyManager: '0.1,100.00,P',
  leaseLength: '1',
  leaseRenewalFee: '0.25,100.00,P',
  turnover: '3',
  procurementFee: '1.0,1100,P',
  mortgageRate: '0.0425',
  mortgageTerm: '30',
  insurance: '0.007,700.00,P',
  propertyTax: '0.01,1000.00,P',
  vacancyRate: '0.05',
  majorMinorCapEx: '0.1,100,P',
};

export const DataProvider = ({ children }) => {
  const [data, setData] = useState(defaults);
  const [evalData, setEvalData] = useState({});
  const [warnings, setWarnings] = useState({});
  const [valueCompare, setValueCompareX] = useState(null);

  useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const initialData = {};
    Object.keys(defaults).forEach((key) => {
      if (key === 'name' && urlParams.get(key) !== null) {
        document.title = `Reval - ${urlParams.get(key)}`;
      }
      initialData[key] = urlParams.get(key) ? urlParams.get(key) : defaults[key];
    });
    evaluate(initialData);
  }, []);

  const setDataValue = (name, value) => {
    if (name === 'name') {
      document.title = `Reval - ${value}`;
    }
    const updatedData = {
      ...data,
      [name]: value,
    };
    evaluate(updatedData);
  };

  const evaluate = (data) => {
    setData(data);
    const [evalData, evalWarnings] = evaluateData(data);
    setEvalData(evalData);
    setWarnings(evalWarnings);
  };

  const setValueCompare = (active) => {
    setValueCompareX(active ? evalData : null);
  };

  return (
    <DataContext.Provider
      value={{ data, setDataValue, evalData, warnings, valueCompare, setValueCompare }}
    >
      {children}
    </DataContext.Provider>
  );
};

DataProvider.propTypes = {
  children: PropTypes.oneOfType([PropTypes.arrayOf(PropTypes.node), PropTypes.node]).isRequired,
};
